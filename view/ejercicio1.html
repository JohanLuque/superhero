<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buenos malos</title>
  <!-- Bootstrap v5.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="row">
      <p>Buenos y malos de una empresa publicadora seleccionada por el usuario
      </p>
      <!-- Aqui renderizamos el grafico -->
      <div class="col-md-7">
        <canvas id="grafico"></canvas>
      </div>

      <!-- Ahora construiremos un formularios -->
      <div class="col-md-5">
        <div class="form-floating">
          <select name="publishers" id="publishers" class="form-select">
            <option value="">Seleccione</option>
          </select>
          <label for="publishers">Publicadoras</label>
        </div>
        <div class="mt-3">
        <button class="btn btn-sm btn-primary" id="buscar">Buscar</button>
        </div>
      </div>
    </div>
  </div>

    
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded",() => {
      const grafico = document.getElementById("grafico");
      const btBuscar= document.querySelector("#buscar");
      const leyenda = document.querySelector("#lista-leyenda");
      const lispublicadora = document.querySelector("#publishers");

      function listpublisher(){
        const parametros = new URLSearchParams();
        parametros.append("operacion", "listar");
        fetch('../controller/publisher.controller.php',{
          method: 'POST',
          body:parametros
        })
          .then (response => response.json())
          .then(datos=>{
            datos.forEach(element => { 
              const optionTag = document.createElement("option");
              optionTag.value = element.id;
              optionTag.text = element.publisher_name;
              lispublicadora.appendChild(optionTag);
            });
          });
      }
  
      const graficoBarras = new Chart(grafico, {
        type: 'pie',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Buenos malos',
              backgroundColor: ['red', 'blue'],  
              data: []
            }
          ]
        }
      });

      function renderGraphic(coleccion = []){
      let etiquetas = [];
      let datos = [];

      coleccion.forEach(element => {
        etiquetas.push(element.alignment);
        datos.push(element.total);
      });

      //Asinacion de datos
      graficoBarras.data.labels = etiquetas;
      graficoBarras.data.datasets[0].data = datos;
      graficoBarras.update();
    }

    function loadData (){
      const parametros = new URLSearchParams();
      parametros.append("operacion", "resumenBuenosMalos");
      parametros.append("publisher_id", lispublicadora.value);

      fetch('../controller/superhero.controller.php', {
        method: 'POST',
        body: parametros
      })
      .then(response => response.json())
      .then(datos => {
        renderGraphic(datos);
      })
    }
    
    listpublisher();

    btBuscar.addEventListener("click", loadData);
  
      
    })
  </script>
</body>
</html>